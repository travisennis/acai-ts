# Session File Name Discrepancy Bug

## Research Question

Why does the `/session` command display a session file name that doesn't match the actual file name on disk?

## Overview

The `/session` command displays session metadata including a "Session File" field that shows an incorrect file name format. The displayed name includes a timestamp prefix (e.g., `session-2025-01-29T12-34-56-{sessionId}.json`), but the actual file saved to disk uses a simpler format without the timestamp (`session-{sessionId}.json`). This discrepancy confuses users who try to locate the session file.

## Key Findings

### 1. Display Logic (Incorrect Format)

**Location**: `source/commands/session/index.ts:97`

The `/session` command constructs the displayed file name by combining the session creation timestamp with the session ID:

```typescript
const sessionFile = `session-${createdAt.toISOString().replace(/[:.]/g, "-").slice(0, 19)}-${sessionId}.json`;
```

This produces a filename like:
- `session-2025-01-29T12-34-56-550e8400-e29b-41d4-a716-446655440000.json`

**Evidence**: `source/commands/session/index.ts:97`

### 2. Save Logic (Correct Format)

**Location**: `source/sessions/manager.ts:309`

The actual file saving logic uses only the session ID:

```typescript
const fileName = `session-${this.sessionId}.json`;
```

This produces a filename like:
- `session-550e8400-e29b-41d4-a716-446655440000.json`

**Evidence**: `source/sessions/manager.ts:309`

### 3. File Loading Logic

**Location**: `source/sessions/manager.ts:520-521`

The file loading logic in `SessionManager.load()` filters for files matching the pattern:

```typescript
const sessionFiles = files.filter(
  (file) => file.startsWith("session-") && file.endsWith(".json"),
);
```

This pattern would match both naming formats, but since files are only saved with the simpler format, only those are loaded.

**Evidence**: `source/sessions/manager.ts:520-521`

## Architecture & Design Patterns

### Pattern 1: Session File Naming

- **Description**: Session files are named using the pattern `session-{sessionId}.json` where `sessionId` is a UUID generated by `randomUUID()` from `node:crypto`.
- **Example**: `source/sessions/manager.ts:309`
- **When Used**: All session persistence operations use this naming convention.

### Pattern 2: Session Metadata Display

- **Description**: The `/session` command displays comprehensive session information in a modal dialog, including session ID, file name, model, title, duration, and timestamps.
- **Example**: `source/commands/session/index.ts:60-200`
- **When Used**: When user runs `/session` command in the REPL.

## Data Flow

### Session File Creation Flow

1. **Session Creation**: `SessionManager.create()` generates a new UUID via `randomUUID()` (`source/sessions/manager.ts:83`)
2. **Session Saving**: `SessionManager.save()` constructs the filename as `session-${this.sessionId}.json` (`source/sessions/manager.ts:309`)
3. **File Writing**: The session data is written to the constructed file path in the state directory (`source/sessions/manager.ts:310-339`)

### Session File Display Flow

1. **Command Invocation**: User runs `/session` command
2. **Data Retrieval**: `sessionCommand` retrieves session metadata via `sessionManager` getters (`source/commands/session/index.ts:93-96`)
3. **File Name Construction**: The displayed file name is constructed with timestamp prefix (`source/commands/session/index.ts:97`)
4. **Display**: The file name is shown in the metadata table (`source/commands/session/index.ts:131`)

## Components & Files

### Core Components

| Component | File(s) | Responsibility |
|-----------|---------|----------------|
| SessionManager | `source/sessions/manager.ts` | Manages session state, persistence, and retrieval |
| SessionCommand | `source/commands/session/index.ts` | Displays session information in TUI modal |
| Session File Storage | `~/.acai/sessions/` | Directory where session files are persisted |

### Configuration

- **State Directory**: `~/.acai/sessions/` (configured via `stateDir` parameter)
- **File Extension**: `.json`
- **File Pattern**: `session-{uuid}.json`

## Integration Points

### Dependencies

- `node:crypto` - For UUID generation via `randomUUID()`
- `node:fs/promises` - For file system operations
- `node:path` - For path construction

### Consumers

- `/session` command - Displays session file name (incorrectly)
- `/history` command - Lists and resumes sessions from files
- `--continue` flag - Resumes previous sessions
- `--resume` flag - Resumes specific or latest session

## Edge Cases & Error Handling

### Edge Cases

1. **Empty Session ID**: The save method validates that `sessionId` is not empty before saving (`source/sessions/manager.ts:315-317`)
2. **Non-array History**: The save method validates that history is an array (`source/sessions/manager.ts:319-321`)
3. **Interrupted Saves**: The save method uses atomic writes (temp file + rename) to prevent corrupted files (`source/sessions/manager.ts:311, 332-334`)
4. **Empty Files**: The load method silently skips empty files that may result from interrupted saves (`source/sessions/manager.ts:551-554`)

### Error Handling

- Save errors are logged but not thrown to prevent crashes during interrupt handlers (`source/sessions/manager.ts:336-349`)
- Load errors for individual files are logged but don't fail the entire load operation (`source/sessions/manager.ts:570-576`)
- Missing state directory is handled gracefully (returns empty array) (`source/sessions/manager.ts:579-583`)

## Known Limitations

1. **Display Inaccuracy**: The `/session` command shows a file name that doesn't exist on disk, confusing users trying to locate their session files.
2. **Timestamp in Display**: The displayed format includes a timestamp that appears to be a legacy or aspirational format that was never implemented in the actual save logic.

## Testing Coverage

### Existing Tests

- No specific tests found for session file naming in the test directory
- Session manager tests likely exist but weren't examined in this research

### Test Gaps

- No test verifying that displayed file name matches actual saved file name
- No test for the file naming format consistency between save and display

## Root Cause Analysis

The discrepancy appears to be a **code synchronization issue**:

1. The display logic (`source/commands/session/index.ts:97`) was likely written with the intention of including timestamps in filenames
2. The save logic (`source/sessions/manager.ts:309`) was either:
   - Simplified to exclude timestamps for practical reasons (shorter names, easier to reference)
   - Never updated to match the display logic's intended format
   - Changed at some point without updating the display logic

The fix is straightforward: update the display logic in `source/commands/session/index.ts:97` to match the actual save format used in `source/sessions/manager.ts:309`.

## Recommendations for Planning

Based on this research, when implementing the fix:

1. **Fix Location**: Modify `source/commands/session/index.ts:97` to use the correct format
2. **Correct Format**: `session-${sessionId}.json` (matching `source/sessions/manager.ts:309`)
3. **Remove Timestamp**: Eliminate the `createdAt.toISOString()` portion from the displayed file name
4. **Test**: Add a test to verify the displayed file name matches the actual saved file format
5. **Consider**: Whether to include the full path (`~/.acai/sessions/`) in the display for better user experience

## Fix Implementation

The fix requires changing line 97 in `source/commands/session/index.ts`:

**Current (incorrect)**:
```typescript
const sessionFile = `session-${createdAt.toISOString().replace(/[:.]/g, "-").slice(0, 19)}-${sessionId}.json`;
```

**Fixed (correct)**:
```typescript
const sessionFile = `session-${sessionId}.json`;
```

This simple change aligns the displayed file name with the actual file name used by `SessionManager.save()`.

## References

- Original ticket: `.tickets/at-9f25.md`
- Display logic: `source/commands/session/index.ts:97`
- Save logic: `source/sessions/manager.ts:309`
- Load logic: `source/sessions/manager.ts:520-521`
- Related research: `.research/session-rendering-comparison.md`
