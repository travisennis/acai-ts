type EastAsianWidthType =
  | "fullwidth"
  | "halfwidth"
  | "wide"
  | "narrow"
  | "neutral"
  | "ambiguous";

interface EastAsianWidthOptions {
  ambiguousAsWide?: boolean;
}

function validate(codePoint: number): asserts codePoint is number {
  if (!Number.isSafeInteger(codePoint)) {
    throw new TypeError(`Expected a code point, got \`${typeof codePoint}\`.`);
  }
}

// Individual code points that are ambiguous (stored in Set for O(1) lookup)
const AMBIGUOUS_CODE_POINTS = new Set([
  0xa1,
  0xa4,
  0xa7,
  0xa8,
  0xaa,
  0xad,
  0xae, // 0xa1-0xae range (partial)
  0xc6,
  0xd0,
  0xd7,
  0xd8, // 0xc6-0xd8 range (partial)
  0xe6,
  0xec,
  0xed,
  0xf0,
  0xf2,
  0xf3, // 0xe6-0xf3 range (partial)
  0xfc,
  0xfe, // 0xfc-0xfe
  0x101,
  0x111,
  0x113,
  0x11b, // 0x101-0x11b range (partial)
  0x126,
  0x127,
  0x12b, // 0x126-0x12b range (partial)
  0x138, // 0x138
  0x144, // 0x144
  0x14d,
  0x152,
  0x153, // 0x14d-0x153 range (partial)
  0x166,
  0x167,
  0x16b, // 0x166-0x16b range (partial)
  0x1ce,
  0x1d0,
  0x1d2,
  0x1d4,
  0x1d6,
  0x1d8,
  0x1da,
  0x1dc, // 0x1ce-0x1dc range
  0x251,
  0x261, // 0x251-0x261 range (partial)
  0x2c4,
  0x2c7, // 0x2c4-0x2c7 range (partial)
  0x2cd,
  0x2d0, // 0x2cd-0x2d0 range (partial)
  0x2dd,
  0x2df, // 0x2dd-0x2df range (partial)
  0x401,
  0x451, // 0x401, 0x451
  0x2010, // 0x2010
  0x2018,
  0x2019,
  0x201c,
  0x201d, // 0x2018-0x201d range
  0x2020,
  0x2021,
  0x2022, // 0x2020-0x2022 range
  0x2024,
  0x2025,
  0x2026,
  0x2027, // 0x2024-0x2027 range
  0x2030,
  0x2032,
  0x2033,
  0x2035, // 0x2030-0x2035 range (partial)
  0x203b,
  0x203e, // 0x203b-0x203e range
  0x2074,
  0x207f, // 0x2074-0x207f range
  0x20ac, // 0x20ac
  0x2103,
  0x2105,
  0x2109, // 0x2103-0x2109 range (partial)
  0x2113,
  0x2116, // 0x2113-0x2116 range
  0x2121,
  0x2122,
  0x2126,
  0x212b, // 0x2121-0x212b range
  0x2153,
  0x2154, // 0x2153-0x2154
  0x2189, // 0x2189
  0x21b8,
  0x21b9, // 0x21b8-0x21b9
  0x21d2,
  0x21d4, // 0x21d2-0x21d4
  0x21e7, // 0x21e7
  0x2200,
  0x2202,
  0x2203,
  0x2207, // 0x2200-0x2207 range (partial)
  0x2208,
  0x220b, // 0x2208-0x220b range
  0x220f,
  0x2211, // 0x220f-0x2211 range
  0x2215, // 0x2215
  0x221a, // 0x221a
  0x2223,
  0x2225, // 0x2223-0x2225 range
  0x222e, // 0x222e
  0x223c,
  0x223d, // 0x223c-0x223d
  0x2248,
  0x224c, // 0x2248-0x224c
  0x2252, // 0x2252
  0x2260,
  0x2261, // 0x2260-0x2261
  0x226a,
  0x226b, // 0x226a-0x226b
  0x226e,
  0x226f, // 0x226e-0x226f
  0x2282,
  0x2283, // 0x2282-0x2283
  0x2286,
  0x2287, // 0x2286-0x2287
  0x2295,
  0x2299, // 0x2295-0x2299
  0x22a5,
  0x22bf, // 0x22a5-0x22bf
  0x2312, // 0x2312
  0x25a0,
  0x25a1, // 0x25a0-0x25a1
  0x25b2,
  0x25b3, // 0x25b2-0x25b3
  0x25b6,
  0x25b7, // 0x25b6-0x25b7
  0x25bc,
  0x25bd, // 0x25bc-0x25bd
  0x25c0,
  0x25c1, // 0x25c0-0x25c1
  0x25cb, // 0x25cb
  0x25ef, // 0x25ef
  0x2605,
  0x2606, // 0x2605-0x2606
  0x2609, // 0x2609
  0x260e,
  0x260f, // 0x260e-0x260f
  0x261c,
  0x261e, // 0x261c-0x261e
  0x2640,
  0x2642, // 0x2640-0x2642
  0x2660,
  0x2661, // 0x2660-0x2661
  0x266d,
  0x266f, // 0x266d-0x266f
  0x269e,
  0x269f, // 0x269e-0x269f
  0x26bf, // 0x26bf
  0x26e3, // 0x26e3
  0x26e8,
  0x26e9, // 0x26e8-0x26e9
  0x26f4, // 0x26f4
  0x26fb,
  0x26fc,
  0x26fe,
  0x26ff, // 0x26fb-0x26ff
  0x273d, // 0x273d
  0xfffd, // 0xfffd
  0x1f18f,
  0x1f190, // 0x1f18f-0x1f190
]);

// Ranges of ambiguous code points (stored as [start, end] tuples)
const AMBIGUOUS_RANGES: [number, number][] = [
  [0xb0, 0xb4], // Latin Extended Additional
  [0xb6, 0xba], // Latin Extended Additional
  [0xbc, 0xbf], // Latin Extended Additional
  [0xde, 0xe1], // Latin Extended Additional
  [0xe8, 0xea], // Latin Extended Additional
  [0xf7, 0xfa], // Latin Extended Additional
  [0x101, 0x101], // Added for completeness
  [0x111, 0x111],
  [0x113, 0x113],
  [0x11b, 0x11b],
  [0x131, 0x133], // Latin Extended Additional
  [0x13f, 0x142], // Latin Extended Additional
  [0x144, 0x144],
  [0x148, 0x14b], // Latin Extended Additional
  [0x14d, 0x14d],
  [0x152, 0x153], // Latin Extended Additional
  [0x166, 0x167], // Latin Extended Additional
  [0x16b, 0x16b],
  [0x2c9, 0x2cb], // Cyrillic Extended Additional
  [0x2d8, 0x2db], // Cyrillic Extended Additional
  [0x300, 0x36f], // Combining Diacritical Marks
  [0x391, 0x3a1], // Greek and Coptic (uppercase)
  [0x3a3, 0x3a9], // Greek and Coptic (uppercase)
  [0x3b1, 0x3c1], // Greek and Coptic (lowercase)
  [0x3c3, 0x3c9], // Greek and Coptic (lowercase)
  [0x410, 0x44f], // Cyrillic
  [0x2013, 0x2016], // General Punctuation
  [0x2024, 0x2027], // General Punctuation
  [0x215b, 0x215e], // Number Forms
  [0x2160, 0x216b], // Number Forms (Roman numerals)
  [0x2170, 0x2179], // Number Forms (small Roman)
  [0x2190, 0x2199], // Arrows
  [0x21d2, 0x21d2],
  [0x21d4, 0x21d4],
  [0x221d, 0x2220], // Mathematical Operators
  [0x2227, 0x222c], // Mathematical Operators
  [0x2234, 0x2237], // Mathematical Operators
  [0x223c, 0x223d], // Mathematical Operators
  [0x2248, 0x2248],
  [0x224c, 0x224c],
  [0x2252, 0x2252],
  [0x2260, 0x2261], // Mathematical Operators
  [0x2264, 0x2267], // Mathematical Operators
  [0x226a, 0x226b], // Mathematical Operators
  [0x226e, 0x226f], // Mathematical Operators
  [0x2282, 0x2283], // Mathematical Operators
  [0x2286, 0x2287], // Mathematical Operators
  [0x2295, 0x2295],
  [0x2299, 0x2299],
  [0x22a5, 0x22a5],
  [0x22bf, 0x22bf],
  [0x2312, 0x2312],
  [0x2460, 0x24e9], // Enclosed Alphanumerics
  [0x24eb, 0x254b], // Enclosed Alphanumerics
  [0x2550, 0x2573], // Box Drawing
  [0x2580, 0x258f], // Block Elements
  [0x2592, 0x2595], // Block Elements
  [0x25a3, 0x25a9], // Geometric Shapes
  [0x25b2, 0x25b3], // Geometric Shapes
  [0x25b6, 0x25b7], // Geometric Shapes
  [0x25bc, 0x25bd], // Geometric Shapes
  [0x25c0, 0x25c1], // Geometric Shapes
  [0x25c6, 0x25c8], // Geometric Shapes
  [0x25ce, 0x25d1], // Geometric Shapes
  [0x25e2, 0x25e5], // Geometric Shapes
  [0x2605, 0x2606], // Miscellaneous Symbols
  [0x2609, 0x2609],
  [0x260e, 0x260f], // Miscellaneous Symbols
  [0x261c, 0x261e], // Miscellaneous Symbols
  [0x2640, 0x2640],
  [0x2642, 0x2642],
  [0x2660, 0x2661], // Miscellaneous Symbols
  [0x2663, 0x2665], // Miscellaneous Symbols
  [0x2667, 0x266a], // Miscellaneous Symbols
  [0x266c, 0x266c],
  [0x266d, 0x266d],
  [0x266f, 0x266f],
  [0x26c6, 0x26cd], // Miscellaneous Symbols
  [0x26cf, 0x26d3], // Miscellaneous Symbols
  [0x26d5, 0x26e1], // Miscellaneous Symbols
  [0x26e8, 0x26e9], // Miscellaneous Symbols
  [0x26eb, 0x26f1], // Miscellaneous Symbols
  [0x26f4, 0x26f4],
  [0x26f6, 0x26f9], // Miscellaneous Symbols
  [0x26fb, 0x26fc], // Miscellaneous Symbols
  [0x26fe, 0x26ff], // Miscellaneous Symbols
  [0x2776, 0x277f], // Dingbats
  [0x2b56, 0x2b59], // Miscellaneous Symbols and Arrows
  [0x3248, 0x324f], // Enclosed CJK
  [0xe000, 0xf8ff], // Private Use Area
  [0xfe00, 0xfe0f], // Variation Selectors
  [0x1f100, 0x1f10a], // Enclosed Alphanumeric Supplement
  [0x1f110, 0x1f12d], // Enclosed Alphanumeric Supplement
  [0x1f130, 0x1f169], // Enclosed Alphanumeric Supplement
  [0x1f170, 0x1f18d], // Enclosed Alphanumeric Supplement
  [0x1f19b, 0x1f1ac], // Enclosed Alphanumeric Supplement
  [0xe0100, 0xe01ef], // Variation Selectors Supplement
  [0xf0000, 0xffffd], // Supplementary Private Use Area-A
  [0x100000, 0x10fffd], // Supplementary Private Use Area-B
];

function isAmbiguous(codePoint: number): boolean {
  // Check individual code points first (O(1) lookup)
  if (AMBIGUOUS_CODE_POINTS.has(codePoint)) {
    return true;
  }

  // Then check ranges (linear in number of ranges, which is much smaller)
  for (const [start, end] of AMBIGUOUS_RANGES) {
    if (codePoint >= start && codePoint <= end) {
      return true;
    }
  }

  return false;
}

function isFullWidth(codePoint: number): boolean {
  return (
    codePoint === 0x3000 ||
    (codePoint >= 0xff01 && codePoint <= 0xff60) ||
    (codePoint >= 0xffe0 && codePoint <= 0xffe6)
  );
}

const WIDE_RANGES: [number, number][] = [
  [0x1100, 0x115f],
  [0x231a, 0x231b],
  [0x2329, 0x232a],
  [0x23e9, 0x23ec],
  [0x23f0, 0x23f0],
  [0x23f3, 0x23f3],
  [0x25fd, 0x25fe],
  [0x2614, 0x2615],
  [0x2630, 0x2637],
  [0x2648, 0x2653],
  [0x267f, 0x267f],
  [0x268a, 0x268f],
  [0x2693, 0x2693],
  [0x26a1, 0x26a1],
  [0x26aa, 0x26ab],
  [0x26bd, 0x26be],
  [0x26c4, 0x26c5],
  [0x26ce, 0x26ce],
  [0x26d4, 0x26d4],
  [0x26ea, 0x26ea],
  [0x26f2, 0x26f3],
  [0x26f5, 0x26f5],
  [0x26fa, 0x26fa],
  [0x26fd, 0x26fd],
  [0x2705, 0x2705],
  [0x270a, 0x270b],
  [0x2728, 0x2728],
  [0x274c, 0x274c],
  [0x274e, 0x274e],
  [0x2753, 0x2755],
  [0x2757, 0x2757],
  [0x2795, 0x2797],
  [0x27b0, 0x27b0],
  [0x27bf, 0x27bf],
  [0x2b1b, 0x2b1c],
  [0x2b50, 0x2b50],
  [0x2b55, 0x2b55],
  [0x2e80, 0x2e99],
  [0x2e9b, 0x2ef3],
  [0x2f00, 0x2fd5],
  [0x2ff0, 0x2fff],
  [0x3001, 0x303e],
  [0x3041, 0x3096],
  [0x3099, 0x30ff],
  [0x3105, 0x312f],
  [0x3131, 0x318e],
  [0x3190, 0x31e5],
  [0x31ef, 0x321e],
  [0x3220, 0x3247],
  [0x3250, 0xa48c],
  [0xa490, 0xa4c6],
  [0xa960, 0xa97c],
  [0xac00, 0xd7a3],
  [0xf900, 0xfaff],
  [0xfe10, 0xfe19],
  [0xfe30, 0xfe52],
  [0xfe54, 0xfe66],
  [0xfe68, 0xfe6b],
  [0x16fe0, 0x16fe4],
  [0x16ff0, 0x16ff6],
  [0x17000, 0x18cd5],
  [0x18cff, 0x18d1e],
  [0x18d80, 0x18df2],
  [0x1aff0, 0x1aff3],
  [0x1aff5, 0x1affb],
  [0x1affd, 0x1affe],
  [0x1b000, 0x1b122],
  [0x1b132, 0x1b132],
  [0x1b150, 0x1b152],
  [0x1b155, 0x1b155],
  [0x1b164, 0x1b167],
  [0x1b170, 0x1b2fb],
  [0x1d300, 0x1d356],
  [0x1d360, 0x1d376],
  [0x1f004, 0x1f004],
  [0x1f0cf, 0x1f0cf],
  [0x1f18e, 0x1f18e],
  [0x1f191, 0x1f19a],
  [0x1f200, 0x1f202],
  [0x1f210, 0x1f23b],
  [0x1f240, 0x1f248],
  [0x1f250, 0x1f251],
  [0x1f260, 0x1f265],
  [0x1f300, 0x1f320],
  [0x1f32d, 0x1f335],
  [0x1f337, 0x1f37c],
  [0x1f37e, 0x1f393],
  [0x1f3a0, 0x1f3ca],
  [0x1f3cf, 0x1f3d3],
  [0x1f3e0, 0x1f3f0],
  [0x1f3f4, 0x1f3f4],
  [0x1f3f8, 0x1f43e],
  [0x1f440, 0x1f440],
  [0x1f442, 0x1f4fc],
  [0x1f4ff, 0x1f53d],
  [0x1f54b, 0x1f54e],
  [0x1f550, 0x1f567],
  [0x1f57a, 0x1f57a],
  [0x1f595, 0x1f596],
  [0x1f5a4, 0x1f5a4],
  [0x1f5fb, 0x1f64f],
  [0x1f680, 0x1f6c5],
  [0x1f6cc, 0x1f6cc],
  [0x1f6d0, 0x1f6d2],
  [0x1f6d5, 0x1f6d8],
  [0x1f6dc, 0x1f6df],
  [0x1f6eb, 0x1f6ec],
  [0x1f6f4, 0x1f6fc],
  [0x1f7e0, 0x1f7eb],
  [0x1f7f0, 0x1f7f0],
  [0x1f90c, 0x1f93a],
  [0x1f93c, 0x1f945],
  [0x1f947, 0x1f9ff],
  [0x1fa70, 0x1fa7c],
  [0x1fa80, 0x1fa8a],
  [0x1fa8e, 0x1fac6],
  [0x1fac8, 0x1fac8],
  [0x1facd, 0x1fadc],
  [0x1fadf, 0x1faea],
  [0x1faef, 0x1faf8],
  [0x20000, 0x2fffd],
  [0x30000, 0x3fffd],
];

function isWide(codePoint: number): boolean {
  return WIDE_RANGES.some(
    ([start, end]) => codePoint >= start && codePoint <= end,
  );
}

function getCategory(codePoint: number): EastAsianWidthType {
  if (isAmbiguous(codePoint)) return "ambiguous";

  if (isFullWidth(codePoint)) return "fullwidth";

  if (
    codePoint === 0x20a9 ||
    (codePoint >= 0xff61 && codePoint <= 0xffbe) ||
    (codePoint >= 0xffc2 && codePoint <= 0xffc7) ||
    (codePoint >= 0xffca && codePoint <= 0xffcf) ||
    (codePoint >= 0xffd2 && codePoint <= 0xffd7) ||
    (codePoint >= 0xffda && codePoint <= 0xffdc) ||
    (codePoint >= 0xffe8 && codePoint <= 0xffee)
  ) {
    return "halfwidth";
  }

  if (
    (codePoint >= 0x20 && codePoint <= 0x7e) ||
    codePoint === 0xa2 ||
    codePoint === 0xa3 ||
    codePoint === 0xa5 ||
    codePoint === 0xa6 ||
    codePoint === 0xac ||
    codePoint === 0xaf ||
    (codePoint >= 0x27e6 && codePoint <= 0x27ed) ||
    codePoint === 0x2985 ||
    codePoint === 0x2986
  ) {
    return "narrow";
  }

  if (isWide(codePoint)) return "wide";

  return "neutral";
}

export function eastAsianWidthType(codePoint: number): EastAsianWidthType {
  validate(codePoint);
  return getCategory(codePoint);
}

export function eastAsianWidth(
  codePoint: number,
  options: EastAsianWidthOptions = {},
): 1 | 2 {
  const { ambiguousAsWide = false } = options;
  validate(codePoint);
  if (
    isFullWidth(codePoint) ||
    isWide(codePoint) ||
    (ambiguousAsWide && isAmbiguous(codePoint))
  ) {
    return 2;
  }
  return 1;
}
