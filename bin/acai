#!/bin/sh
# acai wrapper script with Node.js compile cache support
# Cache is automatically invalidated when source files change

# Detect one-shot CLI mode (non-interactive)
# Only use alternate screen for TUI/REPL mode
use_alt_screen=true
for arg in "$@"; do
    case "$arg" in
        -p|--prompt|-h|--help|-v|--version)
            use_alt_screen=false
            break
            ;;
    esac
done

ACAI_SUMMARY_FILE="${TMPDIR:-/tmp}/acai-exit-summary.txt"
rm -f "$ACAI_SUMMARY_FILE"

if [ "$use_alt_screen" = true ]; then
    # Save cursor position and switch to alternate screen buffer
    printf '\033[?1049h'

    # Ensure screen restoration happens even on crash/ctrl+c
    cleanup() {
        printf '\033[?1049l'
        if [ -f "$ACAI_SUMMARY_FILE" ]; then
            cat "$ACAI_SUMMARY_FILE"
            rm -f "$ACAI_SUMMARY_FILE"
        fi
    }
    trap cleanup EXIT INT TERM
fi

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Set default compile cache directory if not already set
if [ -z "${NODE_COMPILE_CACHE:-}" ]; then
  if [ "${OSTYPE:-}" = "darwin*" ]; then
    export NODE_COMPILE_CACHE="$HOME/Library/Caches/acai-compile-cache"
  else
    export NODE_COMPILE_CACHE="${XDG_CACHE_HOME:-$HOME/.cache}/acai-compile-cache"
  fi
fi

# Create cache directory if it doesn't exist
mkdir -p "$NODE_COMPILE_CACHE" 2>/dev/null || true

# Execute the actual entry point with compile cache enabled
# Note: don't use exec so trap cleanup runs after node exits
node "$SCRIPT_DIR/../dist/index.js" "$@"
