# Acai Architecture

This document outlines the architecture of the Acai CLI tool.

## Project Structure

```
├── acai-ts
│   ├── .acai
│   │   ├── acai.json
│   │   ├── context
│   │   │   └── selections.json
│   │   ├── docs
│   │   │   ├── available-tools.txt
│   │   │   ├── deleted_tools.md
│   │   │   ├── deleted_tools_88ced9ef.md
│   │   │   ├── issue-4-plan.md
│   │   │   ├── marked-renderer-debug.md
│   │   │   ├── marked-renderer-refactor-plan.md
│   │   │   ├── memory-use-cases.md
│   │   │   ├── refactoring-tools.md
│   │   │   └── system_prompt.txt
│   │   ├── memory
│   │   ├── prompts
│   │   │   └── update-architecture-document.md
│   │   ├── rules.md
│   │   ├── scripts
│   │   │   ├── generateSystemPrompt.ts
│   │   │   └── list-tools.mjs
│   ├── .gitignore
│   ├── .ignore
│   ├── LICENSE
│   ├── README.md
│   ├── biome.json
│   ├── docs
│   ├── knip.json
│   ├── package-lock.json
│   ├── package.json
│   ├── source
│   │   ├── code-utils
│   │   │   └── code-map.ts
│   │   ├── commands
│   │   │   ├── clean-repo.ts
│   │   │   ├── clear-command.ts
│   │   │   ├── commit-command.ts
│   │   │   ├── compact-command.ts
│   │   │   ├── edit-command.ts
│   │   │   ├── edit-prompt-command.ts
│   │   │   ├── exit-command.ts
│   │   │   ├── files-command.ts
│   │   │   ├── generate-rules-command.ts
│   │   │   ├── help-command.ts
│   │   │   ├── init-command.ts
│   │   │   ├── last-log-command.ts
│   │   │   ├── manager.ts
│   │   │   ├── model-command.ts
│   │   │   ├── paste-command.ts
│   │   │   ├── pr-comments-command.ts
│   │   │   ├── prompt-command.ts
│   │   │   ├── ptree-command.ts
│   │   │   ├── reset-command.ts
│   │   │   ├── review-command.ts
│   │   │   ├── rules-command.ts
│   │   │   ├── save-command.ts
│   │   │   ├── selections-command.ts
│   │   │   ├── types.ts
│   │   │   ├── usage-command.ts
│   │   ├── config.ts
│   │   ├── conversation-analyzer.ts
│   │   ├── dedent.ts
│   │   ├── formatting.ts
│   │   ├── index.ts
│   │   ├── logger.ts
│   │   ├── lsp
│   │   │   ├── embedding-instructions.ts
│   │   │   ├── index.ts
│   │   │   └── server.ts
│   │   ├── lsp.ts
│   │   ├── mentions.ts
│   │   ├── messages.ts
│   │   ├── middleware
│   │   │   ├── audit-message.ts
│   │   │   ├── index.ts
│   │   │   ├── rate-limit.ts
│   │   ├── models
│   │   │   ├── ai-config.ts
│   │   │   ├── anthropic-provider.ts
│   │   │   ├── deepseek-provider.ts
│   │   │   ├── google-provider.ts
│   │   │   ├── manager.ts
│   │   │   ├── openai-provider.ts
│   │   │   ├── openrouter-provider.ts
│   │   │   ├── providers.ts
│   │   │   ├── reasoning.ts
│   │   │   └── xai-provider.ts
│   │   ├── parsing.ts
│   │   ├── prompts
│   │   │   └── manager.ts
│   │   ├── prompts.ts
│   │   ├── repl-prompt.ts
│   │   ├── repl.ts
│   │   ├── saved-selections
│   │   │   └── index.ts
│   │   ├── terminal
│   │   │   ├── formatting.ts
│   │   │   ├── index.ts
│   │   │   ├── marked-renderer.ts
│   │   │   ├── types.ts
│   │   ├── token-tracker.ts
│   │   ├── token-utils.ts
│   │   ├── tools
│   │   │   ├── bash-tool.ts
│   │   │   ├── code-interpreter.ts
│   │   │   ├── filesystem.ts
│   │   │   ├── git.ts
│   │   │   ├── grep.ts
│   │   │   ├── index.ts
│   │   │   ├── memory.ts
│   │   │   ├── think.ts
│   │   │   ├── types.ts
│   │   │   ├── url.ts
│   │   │   ├── web-search.ts
│   │   ├── utils
│   │   │   ├── index.ts
│   │   │   └── process.ts
│   ├── tsconfig.json
```

## File Descriptions

*   **`.acai/`**: Directory for acai's internal state, configuration, and temporary files.
    *   `acai.json`: Project-specific acai configuration (commands, tool settings).
    *   `context/selections.json`: Stores saved code selections made via the `/selections` command or LSP actions.
    *   `docs/`: Contains temporary documentation, plans, or debug files generated by acai during operation.
    *   `memory/`: (Reserved for potential future knowledge graph or persistent memory features).
    *   `prompts/`: Stores user-defined, reusable prompts accessible via the `/prompt` command.
    *   `rules.md`: Contains project-specific rules, guidelines, and commands for acai to follow.
    *   `scripts/`: Stores ESM scripts generated by acai for complex, multi-step tasks.
*   **`.gitignore`**: Specifies intentionally untracked files that Git should ignore (logs, dependencies, build output, etc.).
*   **`.ignore`**: (Likely used by file watching or search tools like ripgrep to specify files/directories to ignore beyond `.gitignore`).
*   **`LICENSE`**: Contains the MIT license text governing the use and distribution of the project.
*   **`README.md`**: Provides an overview of the project, features, installation instructions, usage examples, and configuration details.
*   **`biome.json`**: Configuration file for the Biome tool, defining code formatting and linting rules.
*   **`docs/`**: Directory intended for user-created project documentation (currently empty).
*   **`knip.json`**: Configuration file for Knip, a tool used to detect unused files, dependencies, and exports in the project.
*   **`package-lock.json`**: Records the exact versions of all installed dependencies, ensuring reproducible builds across different environments. (Content skipped due to size).
*   **`package.json`**: Defines project metadata (name, version), dependencies, development scripts (build, test, lint), and binary entry points (`acai`, `acai-lsp`).
*   **`source/`**: Contains all the source code for the acai application.
    *   `code-utils/code-map.ts`: Provides the `CodeMap` class to analyze TypeScript source code and generate a structural map (imports, functions, classes, interfaces, types). Used by the LSP for context gathering.
    *   `commands/`: Implements the interactive REPL commands available to the user (e.g., `/help`, `/commit`, `/files`).
        *   `*.ts`: Each file defines a specific REPL command's logic and options.
        *   `manager.ts`: The `CommandManager` class registers all command handlers and routes user input starting with `/` to the appropriate command executor.
        *   `types.ts`: Defines common types and interfaces used across the REPL commands module.
    *   `config.ts`: Exports the `ConfigManager` class, responsible for reading and writing configuration files from both the project's `.acai/` directory and the user's home directory (`~/.acai/`).
    *   `conversation-analyzer.ts`: Implements logic to analyze the conversation history between the user and acai, identifying user corrections to infer new, generalizable rules for improving acai's behavior. These rules are stored in `~/.acai/rules/learned-rules.md`.
    *   `dedent.ts`: Exports a template literal tag function (`dedent`) for removing common leading indentation from multi-line strings.
    *   `formatting.ts`: Provides utility functions for formatting various types of content (code blocks, file content, URLs, XML/Markdown/Bracket blocks) for consistent presentation in prompts or terminal output.
    *   `index.ts`: The main entry point for the `acai` CLI application. It parses command-line arguments using `meow`, initializes core components (ConfigManager, ModelManager, MessageHistory, etc.), sets up the REPL environment, and starts the main interaction loop (`Repl.run()`).
    *   `logger.ts`: Configures and exports the application-wide logger instance using `pino`, configured with rolling file transport to `~/.acai/logs/`.
    *   `lsp/`: Contains the implementation for the Acai Language Server Protocol (LSP) server.
        *   `embedding-instructions.ts`: Defines logic to parse special comments (`//%`) within code files to extract embedded instructions or prompts for LSP code actions.
        *   `index.ts`: Provides the `initializeLsp` function which sets up and starts the LSP server connection.
        *   `server.ts`: Implements the core LSP server functionality, including handling client connections, managing text documents (`TextDocuments`), registering capabilities (like code actions), and processing requests (e.g., `onCodeAction`, `onCodeActionResolve`). It interacts with the AI model to provide code actions like "Instruct" and "Edit".
    *   `lsp.ts`: The entry point for the `acai-lsp` binary, responsible for initializing the `ModelManager` and starting the LSP server via `initializeLsp`.
    *   `mentions.ts`: Implements the logic for handling `@` mentions in user prompts. It detects file paths (`@path/to/file.ts`) or URLs (`@https://...`) and automatically fetches their content to include as context in the prompt sent to the AI.
    *   `messages.ts`: Defines the `MessageHistory` class for managing the conversation log. It handles appending user/assistant messages, saving/loading history to/from files (`.acai/message-history/`), generating conversation titles, and summarizing long conversations.
    *   `middleware/`: Contains middleware functions for use with the AI SDK's model clients.
        *   `audit-message.ts`: Provides middleware (`auditMessage`) to log AI requests and responses to files in the audit directory (`~/.acai/audit/`) for debugging and analysis.
        *   `index.ts`: Barrel file exporting the available middleware components.
        *   `rate-limit.ts`: Provides middleware (`createRateLimitMiddleware`) using `p-throttle` to enforce rate limits on API calls to AI models.
    *   `models/`: Manages AI model providers, configurations, and selection logic.
        *   `*-provider.ts`: Each file defines the specific client configuration, model IDs, and metadata for a particular AI provider (Anthropic, DeepSeek, Google, OpenAI, OpenRouter, XAI).
        *   `ai-config.ts`: The `AiConfig` class determines dynamic AI parameters (like `maxTokens` or reasoning budget/effort) based on the selected model's capabilities and the content of the user's prompt.
        *   `manager.ts`: The `ModelManager` class holds the registry of configured AI models and provides methods (`setModel`, `getModel`, `getModelMetadata`) to manage which model is used for different application tasks (e.g., REPL interaction, LSP code actions, title generation).
        *   `providers.ts`: Centralizes the definition of all supported AI models (`modelRegistry`), their associated metadata (`ModelMetadata`), and provides helper functions (`languageModel`, `isSupportedModel`, `getModelsByProvider`, etc.) for working with different models and providers.
        *   `reasoning.ts`: Implements logic (`calculateThinkingLevel`) to detect keywords (like "think hard") in the user prompt to adjust the reasoning effort or token budget requested from supported AI models.
    *   `parsing.ts`: Provides utility functions for data parsing, currently focused on a preprocessor for Zod schemas (`jsonParser`) to safely parse JSON strings.
    *   `prompts/manager.ts`: Defines the `PromptManager` class, which holds the state of the next prompt to be sent to the AI. It allows adding context (e.g., from file mentions or commands) before the prompt is retrieved and cleared.
    *   `prompts.ts`: Exports the `systemPrompt` function, which dynamically generates the main system prompt provided to the AI model, incorporating core principles, work standards, tool usage guidelines, project-specific rules (`.acai/rules.md`), and environment information.
    *   `repl-prompt.ts`: Implements the user input prompt for the REPL using Node.js `readline`. It handles input history and provides tab completion for both REPL commands and file paths (including `@` mentions).
    *   `repl.ts`: Contains the `Repl` class, which orchestrates the main application loop. It takes user input, handles commands, processes prompts, interacts with the `streamText` API (managing the AI conversation flow, tool calls, and streaming output), displays results in the terminal, and manages conversation history.
    *   `saved-selections/index.ts`: Provides functions (`getSavedSelections`, `saveSelection`, `formatSelection`, `clearSavedSelections`) for managing code snippets saved by the user via the `/selections` command or LSP "Save" code action. Selections are stored in `.acai/context/selections.json`.
    *   `terminal/`: Handles all aspects of terminal input/output formatting and interaction.
        *   `formatting.ts`: Provides low-level functions for terminal manipulation like clearing the screen (`clearTerminal`), setting the title (`setTerminalTitle`), getting terminal size, and formatting Markdown for terminal display using `marked` and a custom renderer.
        *   `index.ts`: Exports the main `Terminal` class, which provides a high-level interface for writing formatted output (welcome message, info, success, error, warnings, tables, progress bars, spinners, links) to the console.
        *   `marked-renderer.ts`: Implements a custom `marked.Renderer` (`TerminalRenderer`) tailored for CLI output. It uses `chalk` for styling, `cli-highlight` for code blocks, and handles elements like lists, tables, blockquotes, and links appropriately for a terminal environment.
        *   `types.ts`: Defines TypeScript types used within the terminal module, such as `TerminalConfig` and `SpinnerInstance`.
    *   `token-tracker.ts`: Exports the `TokenTracker` class, used to monitor and aggregate token usage (prompt, completion, total) for different AI calls made throughout the application (e.g., REPL, title generation, summarization).
    *   `token-utils.ts`: Provides utility functions (`countTokens`, `TokenCounter`) for accurately counting tokens in text using the `tiktoken` library, essential for managing context windows and estimating costs.
    *   `tools/`: Implements the various tools that the AI agent can invoke.
        *   `bash-tool.ts`: Implements the `bashTool` for executing whitelisted shell commands securely within the project directory.
        *   `code-interpreter.ts`: Implements the `codeInterpreter` tool for executing sandboxed JavaScript code using Node.js `vm`.
        *   `filesystem.ts`: Implements tools for interacting with the file system (`readFile`, `readMultipleFiles`, `editFile`, `saveFile`, `moveFile`, `directoryTree`, `deleteFile`, `undoEdit`) with path validation and backup mechanisms.
        *   `git.ts`: Implements Git-related tools (`gitCommit`, `getDiffStat`, `inGitDirectory`) using the `simple-git` library and direct command execution.
        *   `grep.ts`: Implements the `grepFiles` tool using `ripgrep` (`rg`) for searching file contents.
        *   `index.ts`: Initializes and exports all available tools as a single object. It also includes the `askUser` tool (using `@inquirer/prompts`) and sets up the `sendData` mechanism for tools to report progress back to the terminal.
        *   `memory.ts`: (Likely experimental or placeholder) Defines tools for interacting with a potential knowledge graph stored in a file (`createEntities`, `searchNodes`, etc.).
        *   `think.ts`: Implements the `think` tool, a no-op tool allowing the AI to log its thought process for transparency.
        *   `types.ts`: Defines common types used for tool communication, specifically the `Message` union type and the `SendData` function signature for progress reporting.
        *   `url.ts`: Implements the `fetch` tool for retrieving content from URLs, handling HTML cleaning (using `cheerio` or attempting Jina AI Reader) and plain text fetching.
        *   `web-search.ts`: Implements the `webSearch` tool using the Exa (Metaphor) API for performing web searches.
    *   `utils/`: Contains general utility functions used across the application.
        *   `index.ts`: Barrel file exporting utility functions from this directory.
        *   `process.ts`: Provides a robust promise-based wrapper (`executeCommand`) around Node.js `child_process.execFile` for executing external commands with options for timeout, signals, and error handling.
*   **`tsconfig.json`**: Configuration file for the TypeScript compiler (`tsc`), specifying compiler options like target ECMAScript version, module system, output directory, strict type-checking rules, and included source files.

## Flow Diagram

### CLI Flow (`source/index.ts`)

```mermaid
graph TD
    Start[User runs `acai [args]`] --> ParseArgs[index.ts: Parse CLI args (meow)]
    ParseArgs --> LoadConfig[index.ts: Load config (config.ts)]
    LoadConfig --> InitManagers[index.ts: Initialize Managers]
    InitManagers --> ModelMgr[ModelManager]
    InitManagers --> TokenTracker[TokenTracker]
    InitManagers --> MsgHistory[MessageHistory]
    InitManagers --> PromptMgr[PromptManager]
    InitManagers --> CmdMgr[CommandManager]
    InitManagers --> Terminal[Terminal]
    InitManagers --> InitRepl[index.ts: Initialize Repl (repl.ts)]
    InitRepl --> RunRepl[Repl.run()]
    RunRepl --> InputLoop{REPL Loop}
    InputLoop -- User Input --> ReplPrompt[repl-prompt.ts: Get Input w/ Completion]
    ReplPrompt -- Command --> HandleCmd[CommandManager.handle()]
    HandleCmd -- Handled --> InputLoop
    ReplPrompt -- Prompt --> ProcessMentions[mentions.ts: Process @mentions]
    ProcessMentions --> SetPrompt[PromptManager.set()]
    SetPrompt --> PrepareAI[Repl: Prepare AI Call]
    PrepareAI --> GetHistory[MessageHistory.get()]
    PrepareAI --> GetSystemPrompt[prompts.ts: Get System Prompt]
    PrepareAI --> GetTools[tools/index.ts: Init Tools]
    PrepareAI --> StreamAI{streamText (AI SDK)}
    StreamAI -- Tool Call --> ToolExec[tools/*: Execute Tool]
    ToolExec -- Result --> StreamAI
    StreamAI -- Text Delta --> DisplayText[Terminal: Display Output]
    StreamAI -- Finish --> UpdateHistory[MessageHistory: Append Response]
    UpdateHistory --> DisplayStats[Terminal: Display Stats (Tokens, Diff)]
    DisplayStats --> InputLoop
    InputLoop -- /exit --> End[Exit]
    HandleCmd -- /exit --> End
```

### LSP Flow (`source/lsp.ts`)

```mermaid
graph TD
    Start[User runs `acai-lsp`] --> InitLsp[lsp.ts: Initialize LSP]
    InitLsp --> LoadModelMgr[lsp.ts: ModelManager]
    InitLsp --> InitServer[lsp/index.ts: initializeLsp]
    InitServer --> CreateDocs[lsp/server.ts: createTextDocuments]
    InitServer --> CreateConn[lsp/server.ts: initConnection]
    CreateConn --> RegisterHandlers[lsp/server.ts: Register Event Handlers]
    RegisterHandlers -- onInitialize --> HandleInit[Handle Initialize]
    RegisterHandlers -- onDidChangeContent --> HandleDocChange[Handle Document Change]
    HandleDocChange --> UpdateRelations[lsp/server.ts: updateFileRelations]
    RegisterHandlers -- onCodeAction --> ProvideActions[Provide Code Actions (Instruct, Edit, Save)]
    RegisterHandlers -- onCodeActionResolve --> ResolveAction{Resolve Code Action}
    ResolveAction -- ai.instruct --> Instruct[Handle Instruct Action]
    ResolveAction -- ai.edit --> Edit[Handle Edit Action]
    ResolveAction -- ai.save --> Save[Handle Save Action]
    Instruct --> ParseInstr[lsp/embedding-instructions.ts: parseInstructions]
    Instruct --> BuildPrompt[lsp/server.ts: createUserPrompt (with context)]
    Instruct --> CallAI[generateText (AI SDK)]
    CallAI -- Response --> ApplyEdit[Apply TextEdit to Document]
    Edit --> ParseInstr[lsp/embedding-instructions.ts: parseInstructions]
    Edit --> BuildPrompt[lsp/server.ts: createUserPrompt (with context)]
    Edit --> CallAIEdit[generateText (AI SDK - structured output)]
    CallAIEdit -- Response --> ApplyEdits[Apply Multiple TextEdits]
    Save --> SaveSelection[saved-selections/index.ts: saveSelection]

    subgraph Context Gathering
        BuildPrompt --> GetCurrentContext[lsp/server.ts: getCurrentFileContext]
        BuildPrompt --> GetRecentEdits[lsp/server.ts: Get recent edits (editHistory)]
        BuildPrompt --> GetRelatedContext[lsp/server.ts: getRelatedFilesContext]
        GetRelatedContext --> ReadRelatedFiles[Read related files (FS/documents)]
        ReadRelatedFiles --> FormatContext[formatting.ts: formatFile/formatCodeSnippet]
    end
```
